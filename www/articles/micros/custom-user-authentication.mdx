---
title: How to build a Secure Custom Authentication API
publishedAt: 09/08/2023
lastUpdated: 09/08/2023
description: Learn how to set up a Next.js app with a custom authentication API.
slug: how-to-build-a-secure-custom-authentication-api
category: micros
tags: [Express, Nodejs, JavaScript, Supabase, JWT, Bcrypt, Helmet, CORS, Morgan, Dotenv, Nodemon, express-slow-down, express-rate-limit, Railway]
features: [REST API, User Authentication, Hosting]
---

TECH: Nodejs, Express, Supabase, JWT, Bcrypt

x Create a new nodejs project
x Install express
x Create a new express app

- Test hello world route via http file on VSCode
  - quick intro to cURL and the .http file in VSCode
- Test hello world route via postman
  - quick intro to postman and where to install it

- Install Helmet
  - Highlight what Helmet does
  - Configure Helmet into the express app
  - Discuss benifits of Helmet

- Install Cors 
  - Highlight what Cors does
  - Configure Cors into the express app
  - Discuss benifits of Cors

- Install Morgan
  - Highlight what Morgan does
  - Configure Morgan into the express app
  - Discuss benifits of Morgan

- express-slow-down, express-rate-limit
  - Highlight what each package does
  - Configure each package
  - Discuss benifits of each package

- Nodemon 
  - Highlight what Nodemon does
  - Configure Nodemon into the express app
  - Discuss benifits of Nodemon  

- Install Dotenv
  - Highlight what Dotenv does
  - Configure Dotenv into the express app and confirm it works
  - Discuss benifits of Dotenv

- Introduce Supabase
  - Provide STRs to create a user table in supabase:
    1. Login to supabase or create a new account
    2. Create a new project
    3. Create a new table called `users`
    4. Add the following columns to the `users` table:
      - id (primary key)
      - email (text)
      - password (text)
      - username (text)
      - security_questions (json)
      - security_answers (json)
      - created_at (timestamp)
      - updated_at (timestamp)
    5. Demo the SQL editor in supabase and CREATE, READ, the DELETE and item in the new `users` table via SQL

- Back to the Express app, Install Supabase
  - Where to find the Supabase API keys
  - Configure Supabase into the express app

- Create user signup route
  - email, password, username
  - security questions

- Create user login route
  - email, password
  - show how to use route in postman and .http
  - highlight that this is not secure yet

- Install Bcrypt
  - Highlight what Bcrypt does
  - Discuss benifits of Bcrypt

- Grab Supabase JWT from Supabase dash
  - Discuss what JWT is
  - Discuss benifits of JWT

- Integrate Bcrypt into the user signup route
- Integrate Bcrypt into the user login route

- Integrate jsonwebtoken into the user signup route
- Integrate jsonwebtoken into the user login route

- Build and test signle user get route

- Build and test signle user log out route

- Create test-driven user logout route
- Create test-driven user delete route
- Create test-driven user update route
- Create test-driven user get route
- Docs 

---

## Initialize a New Node.js Project

1. Open your terminal or command prompt.
2. Navigate to the directory where you'd like to create your new project.
3. Run the following command to initialize a new Node.js project:

```bash
npm init -y
```

## Install Express

1. Ensure you are in the root directory of your newly created Node.js project.
2. Type the following command to install the Express framework:

```bash
npm install express --save
```

## Create an Express Application

1. Create a new file named `app.js` in your project directory.
2. Open `app.js` using your preferred text editor.
3. Insert the following code to set up a basic Express application:

```javascript app.js title="app.js"
const express = require('express');
const app = express();
const port = 3000;

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

## Run the Express Application

1. Open your terminal or command prompt.
2. Navigate to the root directory of your project.
3. Run the following command to start the Express application:

```bash
node app.js
```

4. Open your web browser and navigate to `http://localhost:3000`.
5. You should see the following message: `Hello, world!`.

> **Note:** To stop the Express application, press `Ctrl + C` in your terminal or command prompt.

--- 


## 4 Ways To Test your Express Application

Next, we'll outline four different ways to test your Express application:
1. Using an HTTP File in VS Code
2. Using cURL to Test Your Express Application
3. Using Postman to Test Your Express Application
4. Using Insomnia to Test Your Express Application

While not essential, it's encouraged to try each of these methods to see which one you prefer.

> **Note:** Don't forget to start your Express application before testing it. It will not work if the application is not running.

### Using cURL to Test Your Express Application

cURL is a command-line tool for transferring data using various protocols. It is available on most operating systems and is a great way to test your Express application.

**Installing cURL**

- Download cURL from [the official cURL website](https://curl.se/download.html).
- Follow the installation steps specific to your operating system.

**Testing Your Express Application with cURL**

1. Open your terminal or command prompt.
2. Run the following command to test the "Hello, world!" route:

```bash
curl http://localhost:3000/
```

3. You should receive a response displaying "Hello, world!"

### Using an HTTP File in VS Code

Visual Studio Code (VS Code) provides an `.http` file extension to simulate cURL-like requests directly within the editor. This is a great way to test your Express application without having to use the command line.

1. Create a new file named `requests.http` in your project directory.
2. Open `requests.http` using VS Code.
3. Add the following line to test the "Hello, world!" route:
```http
GET http://localhost:3000/
```
4. Save the file and click the "Send Request" link above the line you've added. You should see "Hello, world!" displayed as the output.

### Using Postman to Test Your Express Application

Postman is a widely used tool for API development and testing. It offers a user-friendly interface to send HTTP requests. In this section, you will learn how to use Postman to test your Express application.

**Installing Postman**

- Download Postman from [the offical Postman website](https://www.postman.com/downloads/).
- Follow the installation steps specific to your operating system.

**Testing Your Express Application with Postman**

1. Open Postman after installation is complete.
2. Click the "New Request" button.
3. In the request type dropdown, select "GET."
4. Enter `http://localhost:3000/` into the URL field.
5. Click the "Send" button. You should receive a response displaying "Hello, world!"

### Using Insomnia to Test Your Express Application

Insomnia is a free, open-source API client that provides a user-friendly interface to send HTTP requests. In this section, you will learn how to use Insomnia to test your Express application.

**Installing Insomnia**

- Download Insomnia from [the official Insomnia website](https://insomnia.rest/download).
- Follow the installation steps specific to your operating system.

**Testing Your Express Application with Insomnia**

1. Open Insomnia after installation is complete.
2. Click the "New Request" button.
3. Enter `http://localhost:3000/` into the URL field.
4. Click the "Send" button. You should receive a response displaying "Hello, world!"

---

## Securing Your Express Application

Now that you've learned how to test your Express application, it's time to secure it from malicious 3rd parties. In this section, you will learn how to secure your Express application using popular open source packages Helmet, CORS, and Morgan, express-slow-down, express-rate-limit. 

First, let's install them in bulk, then we'll configure them one by one.

```bash
npm install helmet cors morgan express-slow-down express-rate-limit --save
```

<CH.Scrollycoding>

### Configuring Dotenv

Dotenv is a middleware package for Express that loads environment variables from a `.env` file into `process.env`. It does this by setting various HTTP headers to allow or deny access to your application from other domains.

To configure Dotenv, make the following modifications to the code to your `app.js` file. You'll also need to create a `.env` file in your project directory and add the following code to it.

<CH.Code>

```javascript app.js focus=1,5
require('dotenv').config();

const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

```bash .env
PORT=3000
NODE_ENV=development
```

</CH.Code>

---

### Configuring Helmet

Helmet is a middleware package for Express that enhances the security of your application. It does this by setting various HTTP headers to guard against common vulnerabilities.

To configure Helmet, add the following code to your `app.js` file.

```javascript app.js focus=4,8
require('dotenv').config();

const express = require('express');
const helmet = require('helmet');
const app = express();
const port = process.env.PORT || 3000;

app.use(helmet());

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

---

### Configuring CORS for Bearer Token Authentication

CORS is a middleware package for Express that enables cross-origin resource sharing. It does this by setting various HTTP headers to allow or deny access to your application from other domains. 

To configure CORS, add the following code to your `app.js` file.

```javascript app.js focus=5,10
require('dotenv').config();

const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const app = express();
const port = process.env.PORT || 3000;

app.use(helmet());
app.use(cors());

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

---

### Configuring Morgan

Morgan is a middleware package for Express that logs HTTP requests to your application. It does this by setting various HTTP headers to allow or deny access to your application from other domains.

To configure Morgan for local development, add the following code to your `app.js` file.

```javascript app.js focus=6,12
require('dotenv').config();

const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const app = express();
const port = process.env.PORT || 3000;

app.use(helmet());
app.use(cors());
app.use(morgan('dev'));

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

---

## Configuring express-slow-down

express-slow-down is a middleware package for Express that slows down HTTP requests to your application. It does this by setting various HTTP headers to allow or deny access to your application from other domains.

To configure express-slow-down, add the following code to your `app.js` file.

```javascript app.js focus=7,14:18
require('dotenv').config();

const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const slowDown = require('express-slow-down');
const app = express();
const port = process.env.PORT || 3000;

app.use(helmet());
app.use(cors());
app.use(morgan('dev'));
app.use(slowDown({
  windowMs: 15 * 60 * 1000,
  delayAfter: 100,
  delayMs: 500
}));

app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

---

## Configuring express-rate-limit

express-rate-limit is a middleware package for Express that limits the number of HTTP requests to your application. It does this by setting various HTTP headers to allow or deny access to your application from other domains.

To configure express-rate-limit, add the following code to your `app.js` file.

```javascript app.js focus=8,20:23
require('dotenv').config();

const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const slowDown = require('express-slow-down');
const rateLimit = require('express-rate-limit');
const app = express();
const port = process.env.PORT || 3000;

app.use(helmet());
app.use(cors());
app.use(morgan('dev'));
app.use(slowDown({
  windowMs: 15 * 60 * 1000,
  delayAfter: 100,
  delayMs: 500
}));
app.use(rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
}));
app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(port, () => {
  console.log(`App is running at http://localhost:${port}`);
});
```

</CH.Scrollycoding>


## Confirming everything works

1. Open your terminal or command prompt.
2. Navigate to the root directory of your project.
3. Run the following command to start the Express application:

```bash
node app.js
```

## Introduction to Supabase

Supabase is an open-source alternative to Firebase, offering a suite of tools like a realtime database, authentication services, and storage solutions. It's an all-in-one backend service that simplifies database and API management.

Follow these steps to create a user table in Supabase:

1. Login or Create a New Account - Navigate to the Supabase website and login to your existing account or sign up for a new one.
2. Create a New Project - From the dashboard, click on the "New Project" button and follow the prompts to initialize your new project.
3. Create a New Table - Navigate to the 'Table Editor' and click on the 'New Table' button. Name the table `users`.
4. Add Columns to `users` Table - Add the following columns to the `users` table:
  - `id` (primary key)
  - `email` (text, unique, not null)) 
  - `password` (text, not null)
  - `username` (text, unique, not null)
  - `security_questions` (json)
  - `security_answers` (json)
  - `created_at` (timestamp, auto-generated)
  - `updated_at` (timestamp, auto-generated)